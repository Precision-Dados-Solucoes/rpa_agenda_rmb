name: RPA Processos Novos - Agendamento Automático

on:
  schedule:
    # Diariamente às 19:10 BRT (22:10 UTC - 10 min após para não conflitar com RPA Agenda 682)
    - cron: '10 22 * * *'
  workflow_dispatch:

env:
  TZ: America/Sao_Paulo
  HEADLESS: true
  CI: true
  GITHUB_ACTIONS: true

jobs:
  rpa-processos-novos:
    name: Executar RPA Processos Novos
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Configurar Timezone
      run: |
        sudo timedatectl set-timezone America/Sao_Paulo
        echo "Timezone configurado: $(date)"

    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Instalar dependências do sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 \
          libxcomposite1 libxdamage1 libxrandr2 libgbm1 \
          libxss1 libasound2t64 libatspi2.0-0 libgtk-3-0 libgdk-pixbuf2.0-0

    - name: Instalar dependências Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install playwright
        playwright install chromium

    - name: Configurar variáveis de ambiente
      run: |
        echo "NOVAJUS_USERNAME=${{ secrets.NOVAJUS_USERNAME }}" >> $GITHUB_ENV
        echo "NOVAJUS_PASSWORD=${{ secrets.NOVAJUS_PASSWORD }}" >> $GITHUB_ENV
        echo "MYSQL_HOST=${{ secrets.MYSQL_HOST }}" >> $GITHUB_ENV
        echo "MYSQL_PORT=${{ secrets.MYSQL_PORT }}" >> $GITHUB_ENV
        echo "MYSQL_USER=${{ secrets.MYSQL_USER }}" >> $GITHUB_ENV
        echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> $GITHUB_ENV
        echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> $GITHUB_ENV

    - name: Criar diretório de downloads
      run: mkdir -p downloads

    - name: Executar RPA Processos Novos
      run: |
        echo "Iniciando RPA Processos Novos..."
        echo "Horário atual: $(date)"
        python rpa_processos_novos.py
        echo "RPA Processos Novos concluído!"

    - name: Upload de logs (em caso de falha)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: rpa-processos-novos-logs-${{ github.run_number }}
        path: |
          downloads/
          debug_*.png
        retention-days: 7

    - name: Notificar sucesso
      if: success()
      run: echo "✅ RPA Processos Novos executado com sucesso! $(date)"

    - name: Notificar falha
      if: failure()
      run: echo "❌ RPA Processos Novos falhou! $(date)"
