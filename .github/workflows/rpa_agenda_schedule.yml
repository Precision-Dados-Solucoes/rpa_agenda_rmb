name: RPA Agenda - Agendamento Autom√°tico

on:
  schedule:
    # Executa √†s 11:00, 14:00 e 16:00 (hor√°rio de S√£o Paulo)
    # Cron: minuto hora dia m√™s dia_da_semana
    # 0 14 * * * = 14:00 UTC (11:00 BRT) - Diariamente
    # 0 17 * * * = 17:00 UTC (14:00 BRT) - Diariamente  
    # 0 19 * * * = 19:00 UTC (16:00 BRT) - Diariamente
    - cron: '0 14 * * *'  # 11:00 BRT (14:00 UTC)
    - cron: '0 17 * * *'  # 14:00 BRT (17:00 UTC)
    - cron: '0 19 * * *'  # 16:00 BRT (19:00 UTC)
  
  # Permite execu√ß√£o manual
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo de teste (sem interface gr√°fica)'
        required: false
        default: 'false'
        type: boolean

env:
  # Configura√ß√£o do fuso hor√°rio
  TZ: America/Sao_Paulo
  
  # Configura√ß√µes do RPA
  HEADLESS: true
  CI: true
  GITHUB_ACTIONS: true

jobs:
  rpa-agenda:
    name: Executar RPA Agenda
    runs-on: ubuntu-latest
    
    # Configurar timezone
    defaults:
      run:
        shell: bash
    
    steps:
    - name: Configurar Timezone
      run: |
        sudo timedatectl set-timezone America/Sao_Paulo
        echo "Timezone configurado: $(date)"
    
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Instalar depend√™ncias do sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxss1 \
          libasound2t64 \
          libatspi2.0-0 \
          libgtk-3-0 \
          libgdk-pixbuf2.0-0 \
          curl \
          gnupg2 \
          apt-transport-https
    
    - name: Instalar drivers ODBC para SQL Server
      run: |
        # Instalar unixODBC (base para pyodbc)
        sudo apt-get install -y unixodbc unixodbc-dev || echo "AVISO: Falha ao instalar unixODBC"
        
        # Tentar instalar Microsoft ODBC Driver for SQL Server (opcional)
        # Se falhar, o script continuar√° funcionando sem Azure SQL
        echo "Tentando instalar drivers ODBC da Microsoft..."
        if curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg 2>/dev/null; then
          UBUNTU_VERSION=$(lsb_release -rs)
          echo "Ubuntu version: $UBUNTU_VERSION"
          echo "deb [arch=amd64,arm64,armhf signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/${UBUNTU_VERSION}/prod $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 2>/dev/null || \
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17 2>/dev/null || \
          echo "AVISO: Drivers ODBC da Microsoft nao instalados (Azure SQL pode nao funcionar)"
        else
          echo "AVISO: Nao foi possivel configurar repositorio Microsoft (Azure SQL pode nao funcionar)"
        fi
        
        # Verificar drivers instalados
        echo "Drivers ODBC instalados:"
        odbcinst -q -d 2>/dev/null || echo "AVISO: Nenhum driver ODBC encontrado (Azure SQL pode nao funcionar)"
    
    - name: Instalar depend√™ncias Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install playwright
        playwright install chromium
        # Verificar se pyodbc foi instalado corretamente
        python -c "import pyodbc; print('pyodbc instalado com sucesso')" || echo "AVISO: pyodbc pode ter problemas no Linux"
        # Instalar depend√™ncias do Playwright manualmente (evitar libasound2)
        sudo apt-get install -y \
          libnss3 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxss1 \
          libasound2t64 \
          libatspi2.0-0 \
          libgtk-3-0 \
          libgdk-pixbuf2.0-0
    
    - name: Configurar vari√°veis de ambiente
      run: |
        echo "NOVAJUS_USERNAME=${{ secrets.NOVAJUS_USERNAME }}" >> $GITHUB_ENV
        echo "NOVAJUS_PASSWORD=${{ secrets.NOVAJUS_PASSWORD }}" >> $GITHUB_ENV
        echo "SUPABASE_HOST=${{ secrets.SUPABASE_HOST }}" >> $GITHUB_ENV
        echo "SUPABASE_PORT=${{ secrets.SUPABASE_PORT }}" >> $GITHUB_ENV
        echo "SUPABASE_DATABASE=${{ secrets.SUPABASE_DATABASE }}" >> $GITHUB_ENV
        echo "SUPABASE_USER=${{ secrets.SUPABASE_USER }}" >> $GITHUB_ENV
        echo "SUPABASE_PASSWORD=${{ secrets.SUPABASE_PASSWORD }}" >> $GITHUB_ENV
        echo "AZURE_SERVER=${{ secrets.AZURE_SERVER }}" >> $GITHUB_ENV
        echo "AZURE_DATABASE=${{ secrets.AZURE_DATABASE }}" >> $GITHUB_ENV
        echo "AZURE_USER=${{ secrets.AZURE_USER }}" >> $GITHUB_ENV
        echo "AZURE_PASSWORD=${{ secrets.AZURE_PASSWORD }}" >> $GITHUB_ENV
        echo "AZURE_PORT=${{ secrets.AZURE_PORT }}" >> $GITHUB_ENV
    
    - name: Criar diret√≥rio de downloads
      run: |
        mkdir -p downloads
        echo "Diret√≥rio de downloads criado"
    
    - name: Executar RPA Agenda
      run: |
        echo "Iniciando RPA Agenda..."
        echo "Hor√°rio atual: $(date)"
        echo "Modo headless: $HEADLESS"
        
        # Executar o RPA principal
        python rpa_agenda_rmb.py
        
        echo "RPA Agenda conclu√≠do!"
    
    - name: Verificar arquivos baixados
      run: |
        echo "Verificando arquivos na pasta downloads:"
        ls -la downloads/ || echo "Pasta downloads vazia ou n√£o encontrada"
        
        # Verificar se h√° arquivos Excel
        find downloads/ -name "*.xlsx" -type f | head -5 || echo "Nenhum arquivo Excel encontrado"
    
    - name: Upload de logs (se houver erro)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: rpa-agenda-logs-${{ github.run_number }}
        path: |
          downloads/
          debug_*.png
        retention-days: 7
    
    - name: Notificar sucesso
      if: success()
      run: |
        echo "‚úÖ RPA Agenda executado com sucesso!"
        echo "üìÖ Data/Hora: $(date)"
        echo "üîÑ Pr√≥xima execu√ß√£o: Verificar cron schedule"
    
    - name: Notificar falha
      if: failure()
      run: |
        echo "‚ùå RPA Agenda falhou!"
        echo "üìÖ Data/Hora: $(date)"
        echo "üîç Verifique os logs para mais detalhes"

  # Job adicional para relat√≥rios di√°rios
  daily-report:
    name: Relat√≥rio Di√°rio
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 19 * * *'  # Apenas √†s 16h (√∫ltima execu√ß√£o do dia)
    
    steps:
    - name: Gerar relat√≥rio di√°rio
      run: |
        echo "üìä Relat√≥rio Di√°rio - RPA Agenda"
        echo "üìÖ Data: $(date)"
        echo "‚úÖ Execu√ß√µes autom√°ticas funcionando normalmente"
        echo "üîÑ Pr√≥ximas execu√ß√µes: 11:00, 14:00 e 16:00 BRT (amanh√£)"
